---
- name: Ubuntu | Install mnemosyne dependencies
  apt: name={{item}} state=present update_cache=yes cache_valid_time=3600
  with_items:
    - python-pip
    - python-dev
    - git
    - python-virtualenv
    - supervisor
  when: ansible_distribution == 'Debian' or ansible_distribution == 'Ubuntu'

- name: Debian | install mongodb
  include: mongodb.yml

- stat: path=/opt/mnemosyne
  register: gitmnemosyne
- name: git clone mnemosyne
  git:
    repo=https://github.com/threatstream/mnemosyne.git
    dest=/opt/mnemosyne
  when: not gitmnemosyne.stat.exists

## FIXME! seems to be run/changed each time?
## https://github.com/ansible/ansible/issues/6191
- name: Install mnemosyne virtualenv
  pip: requirements=/opt/mnemosyne/requirements.txt
    virtualenv=/opt/mnemosyne/env

- stat: path={{ MHN_HOME }}/.addusermnemosyne
  register: addusermnemosyne
- set_fact:
    SECRET: "{{ 100 | random }}"
  when: not addusermnemosyne.stat.exists
- name: ensure mongdb is active
  service: name={{ mongodb_svc }} state=started
- name: add user to hpfeeds
  command: '/opt/hpfeeds/env/bin/python /opt/hpfeeds/broker/add_user.py "{{ IDENT }}" "{{ SECRET }}" "" "{{ CHANNELS }}"'
  when: not addusermnemosyne.stat.exists
- name: Set up mnemosyne config
  template: src=mnemosyne.cfg
    dest=/opt/mnemosyne/mnemosyne.cfg
    owner=0 group=0 mode=0644
  when: not addusermnemosyne.stat.exists
- file: path={{ MHN_HOME }}/.addusermnemosyne state=touch
  when: not addusermnemosyne.stat.exists

- file: path=/var/log/mhn state=directory mode=755

- copy: src=mnemosyne.conf dest=/etc/supervisor/conf.d/mnemosyne.conf mode=0644
  notify:
    - supervisor update

