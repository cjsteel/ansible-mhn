#!/opt/hpfeeds/env/bin/python
## from https://groups.google.com/forum/#!msg/modern-honey-network/szahW2nS2UM/hq-0LhNHXpAJ

import sys
import logging
logging.basicConfig(level=logging.WARNING)
import hpfeeds
import datetime
import json
outstream = sys.stdout
outstream = open( "/var/log/attacks.log", "a", 0 ) 

HOST = 'localhost'
PORT = 10000
CHANNELS = ['dionaea.connections', 'kippo.sessions', ]
IDENT = 'mnemosyne'
SECRET = 'mysecret'


def main():

    hpc = hpfeeds.new(HOST, PORT, IDENT, SECRET)
    print >>sys.stderr, 'connected to', hpc.brokername
    
    def on_message(identifier, channel, payload):
    if channel == 'dionaea.connections':
           try:
        dt = datetime.datetime.now()
        dt2 = dt.strftime('%b %d %H:%M:%S')
        payload = str(payload).strip()
        payload = json.loads(payload)
            print >>outstream, "%s %s MHN: New attack from SRC=%s port %s (generated by dionaea) \n"%(dt2, payload['local_host'], payload['remote_host'], payload['local_port'])
           except Exception, e:
            print >> sys.stderr, "Error", e

    elif channel == 'kippo.sessions':
           try:
        dt = datetime.datetime.now()
        dt2 = dt.strftime('%b %d %H:%M:%S')
        payload = str(payload).strip()
        payload = json.loads(payload)
            print >>outstream, "%s %s MHN: New attack from SRC=%s port %s (generated by kippo) \n"%(dt2, payload['hostIP'], payload['peerIP'], payload['hostPort'])
           except Exception, e:
            print >> sys.stderr, "Error", e

    def on_error(payload):
        print >>sys.stderr, ' -> errormessage from server: {0}'.format(payload)
        hpc.stop()
        outstream.close()

    hpc.subscribe(CHANNELS)
    hpc.run(on_message, on_error)
    hpc.close()
    outstream.close()
    return 0

if __name__ == '__main__':
    try: sys.exit(main())
    except KeyboardInterrupt:
        outstream.close()
        sys.exit(0)


